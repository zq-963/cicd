name: Release - å‘å¸ƒæµç¨‹

# å½“åˆ›å»ºæ–°çš„ tag æ—¶è§¦å‘
on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0, v2.1.3 ç­‰æ ¼å¼
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  # åˆ›å»º GitHub Release
  create-release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—

      # 2. è·å–ç‰ˆæœ¬ä¿¡æ¯
      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      # 3. ç”Ÿæˆå˜æ›´æ—¥å¿—
      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        run: |
          echo "## ğŸ‰ ç‰ˆæœ¬ ${{ steps.version.outputs.version }} å‘å¸ƒè¯´æ˜" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### âœ¨ ä¸»è¦æ›´æ–°" >> CHANGELOG.md
          echo "- æ–°åŠŸèƒ½å’Œæ”¹è¿›" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ› é—®é¢˜ä¿®å¤" >> CHANGELOG.md
          echo "- Bug ä¿®å¤" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ“ æäº¤å†å²" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" -10 >> CHANGELOG.md

      # 4. åˆ›å»º Release
      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»ºå¹¶å‘å¸ƒåˆ° PyPI
  build-and-publish:
    name: æ„å»ºå¹¶å‘å¸ƒåŒ…
    runs-on: ubuntu-latest
    needs: create-release
    permissions:
      contents: read

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python
      - name: è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…æ„å»ºä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      # 4. è¿è¡Œæµ‹è¯•
      - name: å®‰è£…å¹¶è¿è¡Œæµ‹è¯•
        run: |
          pip install -r requirements-dev.txt
          pip install -e .
          pytest tests/ -v

      # 5. æ„å»ºåŒ…
      - name: æ„å»ºåŒ…
        run: |
          python -m build
          ls -lh dist/

      # 6. æ£€æŸ¥åŒ…
      - name: æ£€æŸ¥åŒ…
        run: |
          twine check dist/*

      # 7. ä¸Šä¼ åˆ° artifacts
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: dist/

      # 8. å‘å¸ƒåˆ° PyPI (å–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨çœŸå®å‘å¸ƒ)
      # éœ€è¦åœ¨ GitHub Secrets ä¸­è®¾ç½® PYPI_API_TOKEN
      # - name: å‘å¸ƒåˆ° PyPI
      #   env:
      #     TWINE_USERNAME: __token__
      #     TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      #   run: |
      #     twine upload dist/*

      # æ¨¡æ‹Ÿå‘å¸ƒåˆ° PyPI
      - name: æ¨¡æ‹Ÿå‘å¸ƒåˆ° PyPI
        run: |
          echo "ğŸ“¦ åŒ…å·²æ„å»ºå®Œæˆï¼"
          echo "ğŸ“‹ åŒ…å†…å®¹ï¼š"
          ls -lh dist/
          echo ""
          echo "âœ… åœ¨çœŸå®åœºæ™¯ä¸­ï¼Œè¿™é‡Œä¼šå°†åŒ…ä¸Šä¼ åˆ° PyPI"
          echo "ğŸ’¡ è¦å¯ç”¨çœŸå®å‘å¸ƒï¼Œè¯·ï¼š"
          echo "   1. åœ¨ PyPI åˆ›å»º API Token"
          echo "   2. å°† Token æ·»åŠ åˆ° GitHub Secrets (PYPI_API_TOKEN)"
          echo "   3. å–æ¶ˆä¸Šæ–¹ 'å‘å¸ƒåˆ° PyPI' æ­¥éª¤çš„æ³¨é‡Š"

  # å‘å¸ƒé€šçŸ¥
  notify:
    name: å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: build-and-publish
    if: always()

    steps:
      - name: å‘å¸ƒç»“æœé€šçŸ¥
        run: |
          if [ "${{ needs.build-and-publish.result }}" == "success" ]; then
            echo "âœ… å‘å¸ƒæˆåŠŸï¼"
            echo "ğŸ‰ æ–°ç‰ˆæœ¬å·²å‘å¸ƒ"
          else
            echo "âŒ å‘å¸ƒå¤±è´¥"
            echo "è¯·æ£€æŸ¥æ—¥å¿—æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          fi
