name: Scheduled - å®šæ—¶ä»»åŠ¡

# å®šæ—¶è§¦å‘å’Œæ‰‹åŠ¨è§¦å‘
on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 9:00 UTC (åŒ—äº¬æ—¶é—´ 17:00) è¿è¡Œ
    - cron: '0 9 * * *'
    # æ¯å‘¨æ—¥å‡Œæ™¨ 2:00 UTC è¿è¡Œå®Œæ•´æ£€æŸ¥
    - cron: '0 2 * * 0'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # æ¯æ—¥å¥åº·æ£€æŸ¥
  daily-health-check:
    name: æ¯æ—¥å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    # åªåœ¨æ¯å¤© 9:00 æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ
    if: github.event.schedule == '0 9 * * *' || github.event_name == 'workflow_dispatch'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .

      - name: å¿«é€Ÿæµ‹è¯•
        run: |
          echo "ðŸ” è¿è¡Œå¿«é€Ÿå¥åº·æ£€æŸ¥..."
          pytest tests/ -v -k "not slow"

      - name: ä»£ç è´¨é‡æ£€æŸ¥
        run: |
          echo "ðŸ“Š æ£€æŸ¥ä»£ç è´¨é‡..."
          flake8 calculator --count --statistics

      - name: ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸ“… æ¯æ—¥å¥åº·æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- æ—¥æœŸï¼š$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- çŠ¶æ€ï¼š${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # æ¯å‘¨å®Œæ•´æ£€æŸ¥
  weekly-full-check:
    name: æ¯å‘¨å®Œæ•´æ£€æŸ¥
    runs-on: ubuntu-latest
    # åªåœ¨å‘¨æ—¥ 2:00 è¿è¡Œ
    if: github.event.schedule == '0 2 * * 0'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .

      - name: å®Œæ•´æµ‹è¯•å¥—ä»¶
        run: |
          echo "ðŸ” è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
          pytest tests/ -v --cov=calculator --cov-report=term --cov-report=html

      - name: ä»£ç è´¨é‡å…¨é¢æ£€æŸ¥
        run: |
          echo "ðŸ“Š è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
          flake8 calculator tests --count --statistics
          pylint calculator --max-line-length=88 || true

      - name: æ£€æŸ¥ä¾èµ–æ›´æ–°
        run: |
          echo "ðŸ“¦ æ£€æŸ¥ä¾èµ–åŒ…æ˜¯å¦æœ‰æ›´æ–°..."
          pip list --outdated

      - name: å®‰å…¨æ£€æŸ¥
        run: |
          echo "ðŸ”’ æ£€æŸ¥å®‰å…¨æ¼æ´ž..."
          pip install safety
          safety check --json || true

      - name: ç”Ÿæˆå‘¨æŠ¥
        if: always()
        run: |
          echo "## ðŸ“Š æ¯å‘¨å®Œæ•´æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- æ£€æŸ¥æ—¥æœŸï¼š$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- çŠ¶æ€ï¼š${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ£€æŸ¥é¡¹ç›®" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ä»£ç è´¨é‡æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ä¾èµ–æ›´æ–°æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å®‰å…¨æ¼æ´žæ‰«æ" >> $GITHUB_STEP_SUMMARY

      - name: ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: weekly-coverage-report
          path: htmlcov/
          retention-days: 30

  # ä¾èµ–æ›´æ–°æ£€æŸ¥
  dependency-check:
    name: æ£€æŸ¥ä¾èµ–æ›´æ–°
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…å½“å‰ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: æ£€æŸ¥è¿‡æ—¶çš„åŒ…
        id: outdated
        run: |
          echo "## ðŸ“¦ ä¾èµ–åŒ…æ›´æ–°æƒ…å†µ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          pip list --outdated >> $GITHUB_STEP_SUMMARY || echo "æ‰€æœ‰åŒ…éƒ½æ˜¯æœ€æ–°çš„" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: å®‰å…¨æ¼æ´žæ£€æŸ¥
        run: |
          pip install safety
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”’ å®‰å…¨æ¼æ´žæ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          safety check --json > safety_report.json || true
          if [ -s safety_report.json ]; then
            echo "âš ï¸ å‘çŽ°å®‰å…¨æ¼æ´žï¼Œè¯·æŸ¥çœ‹ safety_report.json" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æœªå‘çŽ°å·²çŸ¥å®‰å…¨æ¼æ´ž" >> $GITHUB_STEP_SUMMARY
          fi

  # å®šæ—¶ä»»åŠ¡çŠ¶æ€é€šçŸ¥
  notification:
    name: ä»»åŠ¡å®Œæˆé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [daily-health-check, weekly-full-check]
    if: always()

    steps:
      - name: ç”Ÿæˆé€šçŸ¥
        run: |
          echo "## ðŸ”” å®šæ—¶ä»»åŠ¡æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- æ¯æ—¥æ£€æŸ¥ï¼š${{ needs.daily-health-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ¯å‘¨æ£€æŸ¥ï¼š${{ needs.weekly-full-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.daily-health-check.result }}" == "failure" ] || [ "${{ needs.weekly-full-check.result }}" == "failure" ]; then
            echo "âš ï¸ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          fi
