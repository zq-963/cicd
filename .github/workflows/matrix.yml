name: Matrix - å¤šçŽ¯å¢ƒæµ‹è¯•

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 8 ç‚¹è¿è¡Œ
    - cron: '0 8 * * 1'
  workflow_dispatch:

jobs:
  # å¤š Python ç‰ˆæœ¬å’Œæ“ä½œç³»ç»Ÿçš„çŸ©é˜µæµ‹è¯•
  test-matrix:
    name: æµ‹è¯• Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      # å³ä½¿æŸä¸ªçŽ¯å¢ƒå¤±è´¥ï¼Œç»§ç»­æµ‹è¯•å…¶ä»–çŽ¯å¢ƒ
      fail-fast: false
      matrix:
        # æµ‹è¯•å¤šä¸ªæ“ä½œç³»ç»Ÿ
        os: [ubuntu-latest, windows-latest, macos-latest]
        # æµ‹è¯•å¤šä¸ª Python ç‰ˆæœ¬
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        # å¯ä»¥æŽ’é™¤ç‰¹å®šç»„åˆ
        exclude:
          - os: macos-latest
            python-version: '3.8'  # macOS ä¸Šä¸æµ‹è¯• Python 3.8

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python
      - name: è®¾ç½® Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      # 3. æ˜¾ç¤º Python ä¿¡æ¯
      - name: æ˜¾ç¤º Python ä¿¡æ¯
        run: |
          python --version
          pip --version

      # 4. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .

      # 5. è¿è¡Œæµ‹è¯•
      - name: è¿è¡Œæµ‹è¯• (Python ${{ matrix.python-version }})
        run: |
          pytest tests/ -v --cov=calculator --cov-report=term

      # 6. ä¸Šä¼ è¦†ç›–çŽ‡åˆ° Codecov (å¯é€‰)
      # - name: ä¸Šä¼ è¦†ç›–çŽ‡åˆ° Codecov
      #   uses: codecov/codecov-action@v3
      #   with:
      #     file: ./coverage.xml
      #     flags: python-${{ matrix.python-version }}
      #     name: py${{ matrix.python-version }}-${{ matrix.os }}

  # é¢å¤–çš„çŽ¯å¢ƒæµ‹è¯•ï¼šä¸åŒçš„ä¾èµ–ç‰ˆæœ¬
  test-dependencies:
    name: æµ‹è¯•ä¾èµ–å…¼å®¹æ€§
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        deps-version:
          - name: "æœ€å°ç‰ˆæœ¬"
            pytest: "pytest==7.4.0"
          - name: "æœ€æ–°ç‰ˆæœ¬"
            pytest: "pytest"

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£… ${{ matrix.deps-version.name }} ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install ${{ matrix.deps-version.pytest }}
          pip install pytest-cov
          pip install -e .

      - name: è¿è¡Œæµ‹è¯•
        run: |
          pytest tests/ -v

  # æµ‹è¯•ç»“æžœæ±‡æ€»
  matrix-summary:
    name: æµ‹è¯•çŸ©é˜µæ€»ç»“
    runs-on: ubuntu-latest
    needs: [test-matrix, test-dependencies]
    if: always()

    steps:
      - name: æ£€æŸ¥æµ‹è¯•ç»“æžœ
        run: |
          echo "## ðŸ“Š çŸ©é˜µæµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-matrix.result }}" == "success" ] && [ "${{ needs.test-dependencies.result }}" == "success" ]; then
            echo "âœ… **æ‰€æœ‰çŽ¯å¢ƒæµ‹è¯•é€šè¿‡ï¼**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- å¤šç‰ˆæœ¬ Python æµ‹è¯•ï¼šâœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "- ä¾èµ–å…¼å®¹æ€§æµ‹è¯•ï¼šâœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **éƒ¨åˆ†æµ‹è¯•å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- å¤šç‰ˆæœ¬ Python æµ‹è¯•ï¼š${{ needs.test-matrix.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- ä¾èµ–å…¼å®¹æ€§æµ‹è¯•ï¼š${{ needs.test-dependencies.result }}" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: æ˜¾ç¤ºæµ‹è¯•çŽ¯å¢ƒä¿¡æ¯
        run: |
          echo "### ðŸ”§ æµ‹è¯•çŽ¯å¢ƒ" >> $GITHUB_STEP_SUMMARY
          echo "- æ“ä½œç³»ç»Ÿï¼šUbuntu, Windows, macOS" >> $GITHUB_STEP_SUMMARY
          echo "- Python ç‰ˆæœ¬ï¼š3.8, 3.9, 3.10, 3.11, 3.12" >> $GITHUB_STEP_SUMMARY
          echo "- æ€»æµ‹è¯•åœºæ™¯ï¼š14 ä¸ª" >> $GITHUB_STEP_SUMMARY
