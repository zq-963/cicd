name: CI - æŒç»­é›†æˆ

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.11'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ä»»åŠ¡
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      # 4. ä»£ç æ ¼å¼æ£€æŸ¥ (flake8)
      - name: Flake8 ä»£ç è§„èŒƒæ£€æŸ¥
        run: |
          # æ£€æŸ¥ä»£ç é£æ ¼ï¼Œå¿½ç•¥è¡Œé•¿åº¦å’Œæ–‡æ¡£å­—ç¬¦ä¸²
          flake8 calculator tests --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 calculator tests --count --max-line-length=88 --statistics
        continue-on-error: false

      # 5. ä»£ç è´¨é‡æ£€æŸ¥ (pylint)
      - name: Pylint ä»£ç è´¨é‡æ£€æŸ¥
        run: |
          pylint calculator --max-line-length=88
        continue-on-error: true  # pylint å¤±è´¥ä¸ä¸­æ–­æµç¨‹

      # 6. ä»£ç æ ¼å¼åŒ–æ£€æŸ¥ (black)
      - name: Black æ ¼å¼æ£€æŸ¥
        run: |
          black --check calculator tests
        continue-on-error: true

  # å•å…ƒæµ‹è¯•ä»»åŠ¡
  test:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-quality  # ä¾èµ–ä»£ç è´¨é‡æ£€æŸ¥

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .

      # 4. è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      - name: è¿è¡Œæµ‹è¯•
        run: |
          pytest tests/ -v --cov=calculator --cov-report=xml --cov-report=html --cov-report=term

      # 5. ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ° artifacts
      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

      # 6. æ˜¾ç¤ºæµ‹è¯•æ€»ç»“
      - name: æµ‹è¯•æ€»ç»“
        if: always()
        run: |
          echo "âœ… æµ‹è¯•å®Œæˆï¼"
          echo "ğŸ“Š è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ"

  # æ„å»ºæ£€æŸ¥ä»»åŠ¡
  build:
    name: æ„å»ºæ£€æŸ¥
    runs-on: ubuntu-latest
    needs: test

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3. å®‰è£…æ„å»ºå·¥å…·
      - name: å®‰è£…æ„å»ºå·¥å…·
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      # 4. æ„å»ºåŒ…
      - name: æ„å»º Python åŒ…
        run: |
          python -m build

      # 5. æ£€æŸ¥åŒ…
      - name: æ£€æŸ¥åŒ…å®Œæ•´æ€§
        run: |
          twine check dist/*

      # 6. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/
          retention-days: 7
